'use strict';
//This is the client-side js file was generated by ChatGPT and then manually edited.
define('forum/filter', ['jquery'], function ($) {
	const page = {};

	function stripHtml(html) { return $('<div/>').html(html).text(); }

	function renderPosts($root, posts) {
		const $out = $('<div class="list-group" />');
		if (!posts || posts.length === 0) {
			$out.append('<div class="list-group-item text-muted">No posts found.</div>');
		} else {
			posts.forEach((p) => {
				const time = p.timestampISO ? `<small class="text-muted d-block">${p.timestampISO}</small>` : '';
				const snippet = stripHtml(p.content || '').slice(0, 400);
				$out.append(`
					<a class="list-group-item list-group-item-action" href="${p.url}">
						<div><strong>${p.title || ('Post #' + p.pid)}</strong></div>
						<div class="small mt-1 text-truncate">${snippet}</div>
						${time}
					</a>
				`);
			});
		}
		$root.find('#filter-results').empty().append($out);
	}

	page.init = function () {
		app.enterRoom('filter');
		const $root = $('[component="filter"]');
		if (!$root.length) return;

		$root.find('#filter-apply').off('click').on('click', function (e) {
			e.preventDefault();
			const start = $root.find('#filter-start').val();
			const end = $root.find('#filter-end').val();
			$root.find('#filter-results').html('<div class="text-center py-3">Loadingâ€¦</div>');
			$.getJSON('/api/filter/posts', { start, end })
				.done(function (data) {
					if (!data || !data.success) {
						$root.find('#filter-results').html('<div class="text-danger">Error loading posts.</div>');
						return;
					}
					renderPosts($root, data.posts || []);
				})
				.fail(function () {
					$root.find('#filter-results').html('<div class="text-danger">Error loading posts.</div>');
				});
		});
	};

	$(window).on('action:ajaxify.end', function (ev, data) {
		if (data && data.url && (data.url === '/filter' || data.url.indexOf('/filter') !== -1)) {
			page.init();
		}
	});

	return page;
});